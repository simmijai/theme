{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Belle - E-commerce{% endblock %}</title>

  <!-- Favicon -->
  <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" />
  
  <!-- CSS -->
  <link rel="stylesheet" href="{% static 'css/plugins.css' %}">
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
    <style>
        /* Popup near-button messages for AJAX wishlist */
        .ajax-popup {
            position: absolute;
            z-index: 2050;
            background: #fff;
            color: #212529;
            border: 1px solid rgba(0,0,0,0.08);
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            white-space: nowrap;
            font-size: 13px;
            opacity: 1;
            transition: opacity 0.25s ease, transform 0.18s ease;
            transform: translateY(0);
        }
        .ajax-popup.fade {
            opacity: 0;
            transform: translateY(-6px);
        }
    </style>
</head>


<body class="template-index belle">
  <div id="pre-loader">
      <img src="{% static 'images/loader.gif' %}" alt="Loading..." />
  </div>

  <div class="pageWrapper">
      {% include 'user_theme/includes/navbar.html' %}
            {% if messages %}
            <div class="container mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}" role="alert">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            <!-- Container for AJAX-inserted messages (used by client-side handlers) -->
            <div id="ajax-messages" class="container mt-3" aria-live="polite" aria-atomic="true"></div>
      {% block content %}{% endblock %}
      {% include 'user_theme/includes/footer.html' %}
  </div>

  <!-- JS Files -->
    <!-- JS Files -->
  <script src="{% static 'js/vendor/jquery-3.3.1.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/vendor/wow.min.js' %}"></script> <!-- add this line -->

  <script src="{% static 'js/plugins.js' %}"></script>
  <script src="{% static 'js/main.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {

    function ajaxFilter(slug) {
        const url = `/products/filter/${slug}/`;
        window.history.pushState({slug: slug}, "", url);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const container = document.querySelector("#product-list");
                container.innerHTML = "";
                data.products.forEach(product => {
                    container.innerHTML += `
                    <div class="col-6 col-sm-6 col-md-4 col-lg-3 item grid-view-item style2">
                        <div class="grid-view_image">
                            <a href="#" class="grid-view-item__link">
                                <img class="grid-view-item__image primary blur-up lazyload"
                                     src="${product.image}" alt="${product.name}" title="${product.name}">
                                <img class="grid-view-item__image hover blur-up lazyload"
                                     src="${product.image}" alt="${product.name}" title="${product.name}">
                            </a>
                            <div class="product-details hoverDetails text-center mobile">
                                <div class="subcategory-name text-muted" style="font-size: 14px;">
                                    ${product.category}
                                </div>
                                <div class="product-name mt-2">
                                    <a href="#" class="text-dark font-weight-bold">${product.name}</a>
                                </div>
                                <div class="product-price mt-1">
                                    <span class="price">â‚¹${product.price}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
            })
            .catch(err => console.error("AJAX Error:", err));
    }

    // Attach handler to both category and subcategory links
    document.querySelectorAll(".category-link, .subcategory-link").forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            const slug = this.dataset.slug;
            ajaxFilter(slug);
        });
    });

    // Handle browser back/forward buttons
    window.addEventListener("popstate", function (event) {
        if (event.state && event.state.slug) {
            ajaxFilter(event.state.slug);
        }
    });

});
</script>
<script>
// Global handler for wishlist clicks: perform AJAX add/remove so page doesn't reload or jump to top.
document.addEventListener('click', function (e) {
    const btn = e.target.closest('.wishlist.add-to-wishlist');
    if (!btn) return;
    e.preventDefault();

    // Determine URL to call
    const url = btn.getAttribute('href');
    if (!url) return;

    // Send AJAX request and expect JSON (view respects X-Requested-With header)
    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                showAjaxMessage('success', data.message || 'Added to wishlist', btn);
                // Optionally toggle a visual state on the heart
                btn.classList.add('active');
            } else {
                showAjaxMessage('info', data.message || 'Already in wishlist', btn);
            }
        })
        .catch(err => {
            console.error('Wishlist AJAX error', err);
            showAjaxMessage('danger', 'Could not update wishlist.', btn);
        });
});

function showAjaxMessage(level, text, anchorEl) {
    // If an anchor element was provided, show a small popup near it.
    if (anchorEl && anchorEl.getBoundingClientRect) {
        const rect = anchorEl.getBoundingClientRect();
        const popup = document.createElement('div');
        popup.className = 'ajax-popup';
        popup.textContent = text;

        // Color by level
        if (level === 'success') popup.style.borderColor = 'rgba(40,167,69,0.2)';
        if (level === 'danger') popup.style.borderColor = 'rgba(220,53,69,0.2)';

        document.body.appendChild(popup);

        // Position: try top-right of anchor
        const offset = 8; // px
        // Measure after append so popup.offsetWidth/Height are available
        const pw = popup.offsetWidth;
        const ph = popup.offsetHeight;
        let left = rect.right + window.scrollX - pw;
        let top = rect.top + window.scrollY - ph - offset;

        // If not enough space above, place below
        if (top < window.scrollY + 8) {
            top = rect.bottom + window.scrollY + offset;
        }

        // If popup is going off left edge, align to left of anchor
        if (left < 8) {
            left = rect.left + window.scrollX;
        }

        // If popup goes beyond right edge, nudge left
        const vw = document.documentElement.clientWidth;
        if (left + pw > vw - 8) left = vw - pw - 8 + window.scrollX;

        popup.style.left = `${left}px`;
        popup.style.top = `${top}px`;

        // Auto-dismiss
        setTimeout(() => {
            popup.classList.add('fade');
            setTimeout(() => popup.remove(), 250);
        }, 3500);

        return;
    }

    // Fallback: insert into ajax-messages container
    const container = document.getElementById('ajax-messages') || document.body;
    const alert = document.createElement('div');
    alert.className = `alert alert-${level}`;
    alert.setAttribute('role', 'alert');
    alert.textContent = text;
    container.prepend(alert);
    // Auto-dismiss after 3.5s
    setTimeout(() => {
        alert.classList.add('fade');
        setTimeout(() => alert.remove(), 300);
    }, 3500);
}
</script>
</body>
</html>
